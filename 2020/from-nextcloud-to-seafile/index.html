<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>从 NextCloud 替换为 Seafile | kWeiZh</title>
<meta name="keywords" content="Software, Gadgets">
<meta name="description" content="之前自己组装了一台 NAS，用作私有云，解决大容量网盘，自己跑的一些小应用的问题，还计划作为软路由。
当时对网盘的选择是 NextCloud，最主要的原因就是这是有名气的 Self Hosted 网盘里，最开源的选项，
而这周末，我还是决定更换到 Seafile。">
<meta name="author" content="zwPapEr">
<link rel="canonical" href="https://page.codespaper.com/2020/from-nextcloud-to-seafile/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://page.codespaper.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://page.codespaper.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://page.codespaper.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://page.codespaper.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://page.codespaper.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-135939181-1', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="从 NextCloud 替换为 Seafile" />
<meta property="og:description" content="之前自己组装了一台 NAS，用作私有云，解决大容量网盘，自己跑的一些小应用的问题，还计划作为软路由。
当时对网盘的选择是 NextCloud，最主要的原因就是这是有名气的 Self Hosted 网盘里，最开源的选项，
而这周末，我还是决定更换到 Seafile。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://page.codespaper.com/2020/from-nextcloud-to-seafile/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-08T00:00:00&#43;08:00" />
<meta property="article:modified_time" content="2020-03-22T20:53:02&#43;08:00" /><meta property="og:site_name" content="kWeiZh" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="从 NextCloud 替换为 Seafile"/>
<meta name="twitter:description" content="之前自己组装了一台 NAS，用作私有云，解决大容量网盘，自己跑的一些小应用的问题，还计划作为软路由。
当时对网盘的选择是 NextCloud，最主要的原因就是这是有名气的 Self Hosted 网盘里，最开源的选项，
而这周末，我还是决定更换到 Seafile。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://page.codespaper.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "从 NextCloud 替换为 Seafile",
      "item": "https://page.codespaper.com/2020/from-nextcloud-to-seafile/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "从 NextCloud 替换为 Seafile",
  "name": "从 NextCloud 替换为 Seafile",
  "description": "之前自己组装了一台 NAS，用作私有云，解决大容量网盘，自己跑的一些小应用的问题，还计划作为软路由。 当时对网盘的选择是 NextCloud，最主要的原因就是这是有名气的 Self Hosted 网盘里，最开源的选项， 而这周末，我还是决定更换到 Seafile。\n",
  "keywords": [
    "Software", "Gadgets"
  ],
  "articleBody": "之前自己组装了一台 NAS，用作私有云，解决大容量网盘，自己跑的一些小应用的问题，还计划作为软路由。 当时对网盘的选择是 NextCloud，最主要的原因就是这是有名气的 Self Hosted 网盘里，最开源的选项， 而这周末，我还是决定更换到 Seafile。\nNextCloud 与 Seafile 简单体会 换到 Seafile 之后，简单用了一下，有一下几点体会：\n iOS 相册内有 10000+ 张照片，同步到网盘上  Seafile 每次尝试同步是，会认为全部已经同步完成，然后逐步检测到未同步照片后同步 NextCloud 每次打开，都会有大量的同步任务，然后这一万张就一直同步不完   iOS 端用户体验  Seafile 感觉是原生 iOS App NextCloud 感觉是网页版套壳   iOS 端上传 6G+ 大文件  Seafile 迟迟不开始，估计是在分块 NextCloud 一直在尝试上传，但是一直失败，最后任务找不到了   历史版本  这个是意外收获，以前都不知道 NextCloud 有历史版本，用了 Seafile 之后，发现两家都有   文件管理  Seafile 中有一个 资料库 的概念，目前还没体会到用处 NextCloud 直接就是一个网盘，用起来比较简单   元文件  Seafile 把文件分块后存储，但是提供 fuse 和 WebDAV 用于查看文件 NextCloud 直接存储文件，可以直接在 data 目录看到元文件和目录结构   部署  Seafile 总共 3 个容器，用 Docker-compose 一起拉起来 NextCloud 两个容器，一个 NextCloud，一个 Postgres 单独部署    最主要影响我的是第一点，同步照片，NextCloud 我尝试过一个晚上没关屏幕，NextCloud 在前台运行， 但是一晚上过去了，没传上去太多，Seafile 反而可以一次次检查，慢慢把所有照片同步上去。\n另外 NextCloud 还出现一些登录失败等小问题，目前主观感觉 Seafile 会更稳定一些， 感觉 C+Python 的 Seafile 在性能上，还是比 php 的 NextCloud 性能要高一些。\n最后，元文件这个问题，我主要是想把文件都放到 OneDrive 上作为云上备份，Seafile 通过 Fuse， 或者导出备份文件的方式，倒也能解决。\n另外，看到一个 Issue 也蛮有意思的，主题大致是有人提出 OwnCloud 开始开发 Golang 版本的 Server 端， 用于替换以前的 php 技术栈，但是看 NextCloud 维护者们还是比较倾向与保护好当前 php 生态， 觉得目前性能上还是足够大部分人使用的。\n作为 Golang 开发者，这当然不是我希望看到的\n所以，后续会迁移到 Seafile，也会关注 OwnCloud 的 NG 。\nSeafile 安装 作为一名容器开发，我当然是选择通过 Docker 安装，\nDocker-compose Arch Linux 直接\nsudo pacman -S docker-compose 当然，Golang 的优秀体质，也可以直接在 Docker compose Release 页面直接下载二进制， 放到 PATH 下就好了。\n再下载对应 docker-compose.yaml 文件，就可以启动多个容器了。\n启动 Seafile 在通过 Docker 安装教程里，能看到给出的 Docker compose 配置文件， 简单说明一下，这个 docker-compose.yaml 配置了 3 个容器，分别是：\n mariadb: 开源版 MySQL Memcached: 加速缓存 Seafile: 本体  我稍微修改了一下：\nversion: '2.0' services: db: image: mariadb:10.1 container_name: seafile-mysql restart: always environment: - MYSQL_ROOT_PASSWORD=Password  # Requested, set the root's password of MySQL service. - MYSQL_LOG_CONSOLE=true ports: - \"13306:3306\" volumes: - /host/dir/mysql:/var/lib/mysql  # Requested, specifies the path to MySQL data persistent store. networks: - seafile-net memcached: image: memcached:1.5.6 restart: always container_name: seafile-memcached entrypoint: memcached -m 256 networks: - seafile-net seafile: image: seafileltd/seafile-mc:latest container_name: seafile restart: always ports: - \"10050:80\" - \"10058:8080\" # - \"10053:443\" # If https is enabled, cancel the comment. volumes: - /host/dir/seafile/:/shared  # Requested, specifies the path to Seafile data persistent store. # - /cabin/umbrella/seafile/seafdav.conf:/opt/seafile/conf/seafdav.conf environment: - DB_HOST=db - DB_ROOT_PASSWD=Password  # Requested, the value shuold be root's password of MySQL service. - TIME_ZONE=Etc/GMT+8  # Optional, default is UTC. Should be uncomment and set to your local time zone. - SEAFILE_ADMIN_EMAIL=admin@example.com # Specifies Seafile admin user, default is 'me@example.com'. - SEAFILE_ADMIN_PASSWORD=adminPassword  # Specifies Seafile admin password, default is 'asecret'. - SEAFILE_SERVER_LETSENCRYPT=false  # Whether to use https or not. - SEAFILE_SERVER_HOSTNAME=hostname.com # Specifies your host name if https is enabled. depends_on: - db - memcached networks: - seafile-net networks: seafile-net: 主要修改的地方是：\n 三个容器，都加了 restart: always: 用于每次开机，容器自启动 数据库容器，加了 ports: - \"13306:3306\": 用于我在宿主机上访问数据库，备份数据库 seafile 容器， ports 增加 \"10058:8080\" 用于暴露 webdav 端口  另外，我没有暴露 443 端口，但是作为全民 https 时代，我当然也不能拖后腿，后面会说到。\n修改完配置文件之后，就可以使用命令启动 Seafile 服务端：\ndocker-compose up -d -d 作为可选项，意思是后台运行，一般配置文件写的有问题的时候， 不带 -d ，前台运行能看到日志，排查错误，还是很方便的， 我们配置文件没问题，当然是直接后台启动。\nWebDAV WebDAV 简单的说，就是把文件读写都转成 HTTP 请求，然后当成一个磁盘挂载到机器上。\n端口 如上文提到，在 seafile 容器里，我多暴露了一个端口 8080 ，主要用户 WebDAV ， 因为 Seafile 在存储文件时，会把文件分割，再将元信息存储到数据库中，主要为了：\n 加密 增量同步 历史版本  但是带来另一个不便，就是哪怕在机器上，也没法访问备份的文件， 所以在宿主机上就需要通过 WebDAV 或者 fuse 挂载之后访问， fuse 的话，目前是只读的，所以就用 WebDAV 了。\n启用 WebDAV Seafile 默认不启用 WebDAV ，我们需要修改配置文件：\nvolumes: - /host/dir/seafile/:/shared  # Requested, specifies the path to Seafile data persistent store. 这是 docker-compose.yaml 中，seafile 容器的 volumes 配置，就是把 seafile 配置文件和数据存储挂到机器上的。 在 /host/dir/seafile 这个文件夹下面， seafile/conf/seafdav.conf 这个配置文件就是 WebDAV 的配置文件， 改成：\n[WEBDAV] enabled = true port = 8080 fastcgi = false share_name = /seafdav 主要是：\n enabled: 开关 port: 端口 fastcgi: 使用进程/线程池来处理多个请求的协议，看起来我没用应该是不应该的 share_name: http 的 uri，就是端口号后面的路径。  修改配置文件之后，重启一下容器，就可以了：\ndocker-compose restart seafile HTTPS 全民 HTTPS 时代，当时不能落后，考虑到我机器上有一个 Nginx 做网关， 所以我决定在 Nginx 做 HTTPS 卸载，再把服务以 HTTP 挂到 Nginx 后面，就是这样：\n\r\r申请泛域名证书 Let’s Encrypt 支持泛域名证书，可真是太方便了，如果域名托管在有插件支持的托管商，就更方便了， 就像我现在放在 Cloudflare，几个命令就能申请下来。\n在官方教程这里选择用的软件，如 Nginx ，和系统，如 ArchLinux ，就能看到详细教程， 当然，下面还要选一下 wildcard ，就是通配符证书。\n  检查 DNS 托管商是否支持，cloudflare, cloudxns, linode, google 都是支持的，不支持的就得另找，或者手配了。\n  安装 certbot: sudo pacman -S certbot certbot-nginx\n  安装 DNS 修改插件： sudo pacman -S certbot-dns-cloudflare ，其他家的，把插件名的 cloudflare 换了就可以。\n  配置 key, 这个可以在插件的说明上看到方法，如 certbot-dns-cloudflare，注意，由于 Cloudflare API 不够灵活，必须要所有 Zone 的 Zone:Zone:Read 和 Zone:DNS:Edit 权限才行。\n 在 API Token 页面，点 新建 Token 输入名字 选择权限 Zone:Zone:Read 和 Zone:DNS:Edit 选择所有 Zone 下一步，确定，就可以了    把 Token 按下面格式放到文件里\n# Cloudflare API token used by Certbot dns_cloudflare_api_token = 0123456789abcdef0123456789abcdef01234567   修改一下 token 文件的权限： chmod 600 token\n  申请证书，注意 *.example.com 的 * 就是泛域名\ncertbot certonly \\  --dns-cloudflare \\  --dns-cloudflare-credentials ~/.secrets/certbot/cloudflare.ini \\  -d *.example.com   配置 Nginx 上文中，已经申请到了泛域名证书，我们配置到 Nginx 上：\n# seafile upstream seafile { server 127.0.0.1:10080; } server { listen 10088 ssl; # listen [::]:443 ssl http2 default_server; server_name seafile.example.com; ssl_certificate \"/etc/letsencrypt/live/example.com-0001/fullchain.pem\"; ssl_certificate_key \"/etc/letsencrypt/live/example.com-0001/privkey.pem\"; ssl_session_cache shared:SSL:1m; ssl_session_timeout 10m; ssl_ciphers HIGH:!aNULL:!MD5; ssl_prefer_server_ciphers on; add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always; client_max_body_size 10000m; location / { proxy_pass http://seafile; add_header Real-Server $upstream_addr; proxy_set_header Host $host; proxy_set_header X-Forwarded-For $remote_addr; } } 配置中，有几个地方是需要注意一下：\n listen 10088 ssl; 中的 ssl 参数标志这是个 HTTPS 端口。 ssl_certificate 和 ssl_certificate_key : letsencrypt 生成的证书对 client_max_body_size 客户端请求 body 大小，这个参数限制了上传文件的大小，直接配置成 10G 了。  配置域名解析 目前我只在局域网里用，所以我直接把域名解析成内网地址了，简单直接， 如果家里有公网地址，seafile 需要公网访问，可以配置成 DDNS，动态配置域名地址。\n",
  "wordCount" : "680",
  "inLanguage": "en",
  "datePublished": "2020-03-08T00:00:00+08:00",
  "dateModified": "2020-03-22T20:53:02+08:00",
  "author":[{
    "@type": "Person",
    "name": "zwPapEr"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://page.codespaper.com/2020/from-nextcloud-to-seafile/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "kWeiZh",
    "logo": {
      "@type": "ImageObject",
      "url": "https://page.codespaper.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://page.codespaper.com/" accesskey="h" title="kWeiZh (Alt + H)">kWeiZh</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://page.codespaper.com/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://page.codespaper.com/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://page.codespaper.com/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      从 NextCloud 替换为 Seafile
    </h1>
    <div class="post-meta"><span title='2020-03-08 00:00:00 +0800 CST'>March 8, 2020</span>&nbsp;·&nbsp;zwPapEr

</div>
  </header> 
  <div class="post-content"><p>之前自己组装了一台 NAS，用作私有云，解决大容量网盘，自己跑的一些小应用的问题，还计划作为软路由。
当时对网盘的选择是 NextCloud，最主要的原因就是这是有名气的 Self Hosted 网盘里，最开源的选项，
而这周末，我还是决定更换到 Seafile。</p>
<h2 id="nextcloud-与-seafile-简单体会">NextCloud 与 Seafile 简单体会<a hidden class="anchor" aria-hidden="true" href="#nextcloud-与-seafile-简单体会">#</a></h2>
<p>换到 Seafile 之后，简单用了一下，有一下几点体会：</p>
<ol>
<li>iOS 相册内有 10000+ 张照片，同步到网盘上
<ul>
<li>Seafile 每次尝试同步是，会认为全部已经同步完成，然后逐步检测到未同步照片后同步</li>
<li>NextCloud 每次打开，都会有大量的同步任务，然后这一万张就一直同步不完</li>
</ul>
</li>
<li>iOS 端用户体验
<ul>
<li>Seafile 感觉是原生 iOS App</li>
<li>NextCloud 感觉是网页版套壳</li>
</ul>
</li>
<li>iOS 端上传 6G+ 大文件
<ul>
<li>Seafile 迟迟不开始，估计是在分块</li>
<li>NextCloud 一直在尝试上传，但是一直失败，最后任务找不到了</li>
</ul>
</li>
<li>历史版本
<ul>
<li>这个是意外收获，以前都不知道 NextCloud 有历史版本，用了 Seafile 之后，发现两家都有</li>
</ul>
</li>
<li>文件管理
<ul>
<li>Seafile 中有一个 <code>资料库</code> 的概念，目前还没体会到用处</li>
<li>NextCloud 直接就是一个网盘，用起来比较简单</li>
</ul>
</li>
<li>元文件
<ul>
<li>Seafile 把文件分块后存储，但是提供 fuse 和 WebDAV 用于查看文件</li>
<li>NextCloud 直接存储文件，可以直接在 data 目录看到元文件和目录结构</li>
</ul>
</li>
<li>部署
<ul>
<li>Seafile 总共 3 个容器，用 Docker-compose 一起拉起来</li>
<li>NextCloud 两个容器，一个 NextCloud，一个 Postgres 单独部署</li>
</ul>
</li>
</ol>
<p>最主要影响我的是第一点，同步照片，NextCloud 我尝试过一个晚上没关屏幕，NextCloud 在前台运行，
但是一晚上过去了，没传上去太多，Seafile 反而可以一次次检查，慢慢把所有照片同步上去。</p>
<p>另外 NextCloud 还出现一些登录失败等小问题，目前主观感觉 Seafile 会更稳定一些，
感觉 C+Python 的 Seafile 在性能上，还是比 php 的 NextCloud 性能要高一些。</p>
<p>最后，元文件这个问题，我主要是想把文件都放到 <code>OneDrive</code> 上作为云上备份，Seafile 通过 Fuse，
或者导出备份文件的方式，倒也能解决。</p>
<p>另外，看到一个 <a href="https://github.com/nextcloud/server/issues/16726">Issue</a> 也蛮有意思的，主题大致是有人提出 OwnCloud 开始开发 Golang 版本的 Server 端，
用于替换以前的 php 技术栈，但是看 NextCloud 维护者们还是比较倾向与保护好当前 php 生态，
觉得目前性能上还是足够大部分人使用的。</p>
<p><del>作为 Golang 开发者，这当然不是我希望看到的</del></p>
<p>所以，后续会迁移到 Seafile，也会关注 OwnCloud 的 <a href="https://github.com/owncloud/ocis">NG</a> 。</p>
<h2 id="seafile-安装">Seafile 安装<a hidden class="anchor" aria-hidden="true" href="#seafile-安装">#</a></h2>
<p>作为一名容器开发，我当然是选择<a href="https://download.seafile.com/published/seafile-manual/docker/deploy%20seafile%20with%20docker.md">通过 Docker 安装</a>，</p>
<h3 id="docker-compose">Docker-compose<a hidden class="anchor" aria-hidden="true" href="#docker-compose">#</a></h3>
<p>Arch Linux 直接</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo pacman -S docker-compose
</code></pre></div><p>当然，Golang 的优秀体质，也可以直接在 <a href="https://github.com/docker/compose/releases">Docker compose Release</a> 页面直接下载二进制，
放到 <code>PATH</code> 下就好了。</p>
<p>再下载对应 <code>docker-compose.yaml</code> 文件，就可以启动多个容器了。</p>
<h3 id="启动-seafile">启动 Seafile<a hidden class="anchor" aria-hidden="true" href="#启动-seafile">#</a></h3>
<p>在<a href="https://download.seafile.com/published/seafile-manual/docker/deploy%20seafile%20with%20docker.md">通过 Docker 安装</a>教程里，能看到给出的 Docker compose 配置文件，
简单说明一下，这个 <code>docker-compose.yaml</code> 配置了 3 个容器，分别是：</p>
<ul>
<li>mariadb: 开源版 MySQL</li>
<li>Memcached: 加速缓存</li>
<li>Seafile: 本体</li>
</ul>
<p>我稍微修改了一下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;2.0&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">db</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mariadb:10.1</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">seafile-mysql</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">environment</span>:
    - <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD=Password </span> <span style="color:#75715e"># Requested, set the root&#39;s password of MySQL service.</span>
    - <span style="color:#ae81ff">MYSQL_LOG_CONSOLE=true</span>
    <span style="color:#f92672">ports</span>:
    - <span style="color:#e6db74">&#34;13306:3306&#34;</span>
    <span style="color:#f92672">volumes</span>:
    - <span style="color:#ae81ff">/host/dir/mysql:/var/lib/mysql </span> <span style="color:#75715e"># Requested, specifies the path to MySQL data persistent store.</span>
    <span style="color:#f92672">networks</span>:
    - <span style="color:#ae81ff">seafile-net</span>

  <span style="color:#f92672">memcached</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">memcached:1.5.6</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">seafile-memcached</span>
    <span style="color:#f92672">entrypoint</span>: <span style="color:#ae81ff">memcached -m 256</span>
    <span style="color:#f92672">networks</span>:
    - <span style="color:#ae81ff">seafile-net</span>

  <span style="color:#f92672">seafile</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">seafileltd/seafile-mc:latest</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">seafile</span>
    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
    <span style="color:#f92672">ports</span>:
    - <span style="color:#e6db74">&#34;10050:80&#34;</span>
    - <span style="color:#e6db74">&#34;10058:8080&#34;</span>
<span style="color:#75715e">#      - &#34;10053:443&#34;  # If https is enabled, cancel the comment.</span>
    <span style="color:#f92672">volumes</span>:
    - <span style="color:#ae81ff">/host/dir/seafile/:/shared  </span> <span style="color:#75715e"># Requested, specifies the path to Seafile data persistent store.</span>
<span style="color:#75715e">#      - /cabin/umbrella/seafile/seafdav.conf:/opt/seafile/conf/seafdav.conf</span>
    <span style="color:#f92672">environment</span>:
    - <span style="color:#ae81ff">DB_HOST=db</span>
    - <span style="color:#ae81ff">DB_ROOT_PASSWD=Password </span> <span style="color:#75715e"># Requested, the value shuold be root&#39;s password of MySQL service.</span>
    - <span style="color:#ae81ff">TIME_ZONE=Etc/GMT+8 </span> <span style="color:#75715e"># Optional, default is UTC. Should be uncomment and set to your local time zone.</span>
    - <span style="color:#ae81ff">SEAFILE_ADMIN_EMAIL=admin@example.com</span> <span style="color:#75715e"># Specifies Seafile admin user, default is &#39;me@example.com&#39;.</span>
    - <span style="color:#ae81ff">SEAFILE_ADMIN_PASSWORD=adminPassword    </span> <span style="color:#75715e"># Specifies Seafile admin password, default is &#39;asecret&#39;.</span>
    - <span style="color:#ae81ff">SEAFILE_SERVER_LETSENCRYPT=false  </span> <span style="color:#75715e"># Whether to use https or not.</span>
    - <span style="color:#ae81ff">SEAFILE_SERVER_HOSTNAME=hostname.com</span> <span style="color:#75715e"># Specifies your host name if https is enabled.</span>
    <span style="color:#f92672">depends_on</span>:
    - <span style="color:#ae81ff">db</span>
    - <span style="color:#ae81ff">memcached</span>
    <span style="color:#f92672">networks</span>:
    - <span style="color:#ae81ff">seafile-net</span>

<span style="color:#f92672">networks</span>:
  <span style="color:#f92672">seafile-net</span>:
</code></pre></div><p>主要修改的地方是：</p>
<ul>
<li>三个容器，都加了 <code>restart: always</code>: 用于每次开机，容器自启动</li>
<li>数据库容器，加了 <code>ports: - &quot;13306:3306&quot;</code>: 用于我在宿主机上访问数据库，备份数据库</li>
<li>seafile 容器， <code>ports</code> 增加 <code>&quot;10058:8080&quot;</code> 用于暴露 <code>webdav</code> 端口</li>
</ul>
<p>另外，我没有暴露 <code>443</code> 端口，但是作为全民 <code>https</code> 时代，我当然也不能拖后腿，后面会说到。</p>
<p>修改完配置文件之后，就可以使用命令启动 Seafile 服务端：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">docker-compose up -d
</code></pre></div><p><code>-d</code> 作为可选项，意思是后台运行，一般配置文件写的有问题的时候，
不带 <code>-d</code> ，前台运行能看到日志，排查错误，还是很方便的，
我们配置文件没问题，当然是直接后台启动。</p>
<h3 id="webdav">WebDAV<a hidden class="anchor" aria-hidden="true" href="#webdav">#</a></h3>
<p><code>WebDAV</code> 简单的说，就是把文件读写都转成 <code>HTTP</code> 请求，然后当成一个磁盘挂载到机器上。</p>
<h4 id="端口">端口<a hidden class="anchor" aria-hidden="true" href="#端口">#</a></h4>
<p>如上文提到，在 <code>seafile</code> 容器里，我多暴露了一个端口 <code>8080</code> ，主要用户 <code>WebDAV</code> ，
因为 Seafile 在存储文件时，会把文件分割，再将元信息存储到数据库中，主要为了：</p>
<ul>
<li>加密</li>
<li>增量同步</li>
<li>历史版本</li>
</ul>
<p>但是带来另一个不便，就是哪怕在机器上，也没法访问备份的文件，
所以在宿主机上就需要通过 <code>WebDAV</code> 或者 <code>fuse</code> 挂载之后访问，
<code>fuse</code> 的话，目前是只读的，所以就用 <code>WebDAV</code> 了。</p>
<h4 id="启用-webdav">启用 <code>WebDAV</code><a hidden class="anchor" aria-hidden="true" href="#启用-webdav">#</a></h4>
<p>Seafile 默认不启用 <code>WebDAV</code> ，我们需要修改配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">volumes</span>:
- <span style="color:#ae81ff">/host/dir/seafile/:/shared  </span> <span style="color:#75715e"># Requested, specifies the path to Seafile data persistent store.</span>
</code></pre></div><p>这是 <code>docker-compose.yaml</code> 中，seafile 容器的 <code>volumes</code> 配置，就是把 seafile 配置文件和数据存储挂到机器上的。
在 <code>/host/dir/seafile</code> 这个文件夹下面， <code>seafile/conf/seafdav.conf</code> 这个配置文件就是 <code>WebDAV</code> 的配置文件，
改成：</p>
<pre><code class="language-nil" data-lang="nil">[WEBDAV]
enabled = true
port = 8080
fastcgi = false
share_name = /seafdav
</code></pre><p>主要是：</p>
<ul>
<li>enabled: 开关</li>
<li>port: 端口</li>
<li>fastcgi: 使用进程/线程池来处理多个请求的协议，看起来我没用应该是不应该的</li>
<li>share_name: http 的 uri，就是端口号后面的路径。</li>
</ul>
<p>修改配置文件之后，重启一下容器，就可以了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">docker-compose restart seafile
</code></pre></div><h3 id="https">HTTPS<a hidden class="anchor" aria-hidden="true" href="#https">#</a></h3>
<p>全民 HTTPS 时代，当时不能落后，考虑到我机器上有一个 Nginx 做网关，
所以我决定在 Nginx 做 HTTPS 卸载，再把服务以 HTTP 挂到 Nginx 后面，就是这样：</p>
<figure>
    <img loading="lazy" src="images/from-nextcloud-to-seafile.org_20200319_231956.png"/> 
</figure>

<h4 id="申请泛域名证书">申请泛域名证书<a hidden class="anchor" aria-hidden="true" href="#申请泛域名证书">#</a></h4>
<p><a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> 支持泛域名证书，可真是太方便了，如果域名托管在有插件支持的托管商，就更方便了，
就像我现在放在 <a href="https://www.cloudflare.com/">Cloudflare</a>，几个命令就能申请下来。</p>
<p>在<a href="https://certbot.eff.org/lets-encrypt/arch-nginx">官方教程</a>这里选择用的软件，如 <code>Nginx</code> ，和系统，如 <code>ArchLinux</code> ，就能看到详细教程，
当然，下面还要选一下 <code>wildcard</code> ，就是通配符证书。</p>
<ol>
<li>
<p>检查 DNS 托管商是否支持，cloudflare, cloudxns, linode, google 都是支持的，不支持的就得另找，或者手配了。</p>
</li>
<li>
<p>安装 certbot: <code>sudo pacman -S certbot certbot-nginx</code></p>
</li>
<li>
<p>安装 DNS 修改插件： <code>sudo pacman -S certbot-dns-cloudflare</code> ，其他家的，把插件名的 <code>cloudflare</code> 换了就可以。</p>
</li>
<li>
<p>配置 key, 这个可以在插件的说明上看到方法，如 <a href="https://certbot-dns-cloudflare.readthedocs.io/en/stable/">certbot-dns-cloudflare</a>，注意，由于 Cloudflare API 不够灵活，必须要所有 Zone 的 <code>Zone:Zone:Read</code> 和 <code>Zone:DNS:Edit</code> 权限才行。</p>
<ol>
<li>在 <a href="https://dash.cloudflare.com/profile/api-tokens">API Token</a> 页面，点 <code>新建 Token</code></li>
<li>输入名字</li>
<li>选择权限 <code>Zone:Zone:Read</code> 和 <code>Zone:DNS:Edit</code></li>
<li>选择所有 Zone</li>
<li>下一步，确定，就可以了</li>
</ol>
</li>
<li>
<p>把 Token 按下面格式放到文件里</p>
<pre><code class="language-nil" data-lang="nil"># Cloudflare API token used by Certbot
dns_cloudflare_api_token = 0123456789abcdef0123456789abcdef01234567
</code></pre></li>
<li>
<p>修改一下 token 文件的权限： <code>chmod 600 token</code></p>
</li>
<li>
<p>申请证书，注意 <code>*.example.com</code> 的 <code>*</code> 就是泛域名</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">certbot certonly <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --dns-cloudflare <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --dns-cloudflare-credentials ~/.secrets/certbot/cloudflare.ini <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -d *.example.com
</code></pre></div></li>
</ol>
<h4 id="配置-nginx">配置 Nginx<a hidden class="anchor" aria-hidden="true" href="#配置-nginx">#</a></h4>
<p>上文中，已经申请到了泛域名证书，我们配置到 Nginx 上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># seafile</span>
upstream seafile <span style="color:#f92672">{</span>
    server  127.0.0.1:10080;
<span style="color:#f92672">}</span>

server <span style="color:#f92672">{</span>
    listen       <span style="color:#ae81ff">10088</span> ssl;
    <span style="color:#75715e">#       listen       [::]:443 ssl http2 default_server;</span>
    server_name  seafile.example.com;

    ssl_certificate <span style="color:#e6db74">&#34;/etc/letsencrypt/live/example.com-0001/fullchain.pem&#34;</span>;
    ssl_certificate_key <span style="color:#e6db74">&#34;/etc/letsencrypt/live/example.com-0001/privkey.pem&#34;</span>;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout  10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security <span style="color:#e6db74">&#34;max-age=31536000; includeSubDomains&#34;</span> always;
    client_max_body_size 10000m;

    location / <span style="color:#f92672">{</span>
        proxy_pass http://seafile;
        add_header Real-Server $upstream_addr;
        proxy_set_header Host            $host;
        proxy_set_header X-Forwarded-For $remote_addr;
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>配置中，有几个地方是需要注意一下：</p>
<ul>
<li><code>listen  10088 ssl;</code> 中的 <code>ssl</code> 参数标志这是个 HTTPS 端口。</li>
<li><code>ssl_certificate</code> 和 <code>ssl_certificate_key</code> : letsencrypt 生成的证书对</li>
<li><code>client_max_body_size</code> 客户端请求 body 大小，这个参数限制了上传文件的大小，直接配置成 <code>10G</code> 了。</li>
</ul>
<h3 id="配置域名解析">配置域名解析<a hidden class="anchor" aria-hidden="true" href="#配置域名解析">#</a></h3>
<p>目前我只在局域网里用，所以我直接把域名解析成内网地址了，简单直接，
如果家里有公网地址，seafile 需要公网访问，可以配置成 DDNS，动态配置域名地址。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://page.codespaper.com/tags/software/">Software</a></li>
      <li><a href="https://page.codespaper.com/tags/gadgets/">Gadgets</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://page.codespaper.com/">kWeiZh</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
